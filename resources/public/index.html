<!DOCTYPE html>
<html lang="en">
<!--
  WARNING! Make sure that you match all Quasar related
  tags to the same version! (Below it's "@1.14.5")
-->

<head>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900|Material+Icons" rel="stylesheet"
          type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/quasar@1.14.5/dist/quasar.min.css" rel="stylesheet" type="text/css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css" rel="stylesheet">
    <title>Todoist sync</title>
    <style>


        .flip-list-enter .flip-list-leave-to {
            opacity: 0;
        }

        /*.flip-list-enter-active {*/
        /*    animation: fadein 1s;*/
        /*}*/

        /*.flip-list-leave {*/
        /*    opacity: 0;*/
        /*}*/

        /*.flip-list-leave-active {*/
        /*    animation: fadein 1s;*/
        /*}*/

        .flip-list-move {
            transition: transform 1s;
        }

        /*@keyframes fadein {*/
        /*    from {*/
        /*        opacity: 0;*/
        /*    }*/
        /*    to {*/
        /*        opacity: 1;*/
        /*    }*/
        /*}*/
    </style>
</head>

<body>

<div id="q-app">
    <div class="q-page-container" style="padding-top: 50px; padding-right: 180px; padding-left: 300px;">
        <div class="q-pa-md">
            <q-form @submit="onSubmit" class="q-gutter-md">
                <div class="q-px-sm">
                    <div v-if="state.todoist">
                        <q-icon name="check_circle" class="text-green"></q-icon>
                        Todoist Authenticated
                    </div>
                    <div v-else>
                        <q-icon name="error" class="text-red"></q-icon>
                        Todoist Is NOT Authenticated! (<a href="oauth2/todoist">Authenticate</a>)
                    </div>
                </div>
                <div class="q-px-sm">
                    <div v-if="state.youtrack">
                        <q-icon name="check_circle" class="text-green"></q-icon>
                        Youtrack Authenticated
                    </div>
                    <div v-else>
                        <q-icon name="error" class="text-red"></q-icon>
                        Youtrack Is NOT Authenticated! (<a href="oauth2/hub">Authenticate</a>)
                    </div>
                </div>

                <q-editor label="Tasks to add" v-model="text" filled type="textarea"></q-editor>
                <div>
                    <q-btn label="Submit" type="submit" color="primary"></q-btn>
                </div>
            </q-form>
        </div>
        <transition-group name="flip-list">
            <div class="q-pa-md" v-for="task in tasks" :key="task">
                <q-banner rounded class="bg-primary text-white">
                    <q-spinner color="white" size="3em" :thickness="10"></q-spinner>
                    <span class="q-px-sm">
                    {{ task.text }}
                </span>
                </q-banner>
            </div>

            <div class="q-pa-md" v-for="output in outputs" :key="output">
                <div class="q-card q-card--bordered no-shadow">
                    <q-toolbar class="text-primary">
                        <q-toolbar-title>{{ output.title }}</q-toolbar-title>
                        <q-btn flat round dense icon="clear" @click="outputClose(output)"></q-btn>
                    </q-toolbar>
                    <div class="q-pa-md">
                        <div v-if="output.data.text"> {{ output.data.text }}</div>
                        <div v-if="output.data['issues-missing']">Issues not in query, but still has an 'Scheduled' Tag:</div>
                        <li v-for="issue in output.data['issues-missing']" :key="issue">
                            <a :href="'https://youtrack.jetbrains.com/issue/' + issue.issue ">{{ issue.issue }}</a> {{ issue.summary }}
                        </li>
                    </div>
                </div>
            </div>
        </transition-group>
    </div>
</div>

<!-- Add the following at the end of your body tag -->

<script src="https://cdn.jsdelivr.net/npm/vue@^2.0.0/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/quasar@1.14.5/dist/quasar.umd.min.js"></script>

<script>
    /*
      Example kicking off the UI. Obviously, adapt this to your specific needs.
      Assumes you have a <div id="q-app"></div> in your <body> above
     */
    new Vue({
        el: '#q-app',
        data: function () {
            return {
                name: null,
                age: null,
                accept: false,
                state: {
                    todoist: false,
                    youtrack: false
                },
                text: '',
                tasks: [],
                outputs: []
            }
        },
        async created() {
            console.log("created");
            let f = await fetch("/json/state");
            let d = await f.json();
            console.log("d = ", d);
            this.state = d;
        },
        methods: {
            outputClose(output) {
                let i = this.outputs.indexOf(output);
                console.log("output close", output, i);
                this.$delete(this.outputs, i)
            },
            onSubmit() {

                let task = {text: "Adding Scheduled Tag"};
                this.tasks.push(task)

                fetch("/json/do-task", {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: this.text,
                        task: "yt-tag-parsed"
                    })
                }).then(async (res) => {
                    let d = await res.json();
                    console.log("post d = ", d);
                    this.$delete(this.tasks, this.tasks.indexOf(task))
                    let items = {title: "Tags added", data: d};
                    console.log("post items = ", JSON.stringify(items) );
                    this.outputs.push(items)
                }).catch(async (e) => {
                    console.log("err  = ", e);
                    this.$delete(this.tasks, this.tasks.indexOf(task))
                    let items = {title: "Error", data: {text: e.message}};
                    console.log("post items = ", JSON.stringify(items) );
                    this.outputs.push(items)
                })
                this.text = '';
            }
        },
        // ...etc
    })
</script>
</body>
</html>
